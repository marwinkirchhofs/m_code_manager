#!/usr/bin/env bash

# !!!IMPORTANT!!!
# This makefile is only meant to be invoked by the top-level makefile.  Some 
# target dependencies might not be appropriate when used in another way.
# !!!


###########################################################
# VARIABLES
###########################################################

RTL_DIR							:= ../rtl
TB_DIR							:= ../tb
TB_INCLUDE_DIR                  := ${TB_DIR}/include
XIL_IPS_DIR						:= ../xil_ips
XIL_IP_COMPILE_FILES			:= $(addsuffix /questa/compile.do, $(wildcard ${XIL_IPS_DIR}/*_sim))

##############################
# TEST PARAMETERIZATION FILES
##############################

CONFIG_ALL                      = $(wildcard *_sim_config.yml)

##############################
# PACKAGES AND INTERFACES
##############################

RTL_SRC_SV                  	+= $(wildcard ${RTL_DIR}/*.sv)

##############################
# FUNCTIONAL BLOCKS
##############################

# DESIGN UNITS
RTL_SRC_SV                  	+= $(wildcard ${RTL_DIR}/*/rtl/*.sv)
RTL_SRC_V                  		+= $(wildcard ${RTL_DIR}/*/rtl/*.v)

# TB
TB_SRC                          += $(wildcard ${TB_DIR}/*.sv)
TB_TOP                   		= tb__TT_APP_ABBREV_TT___T_APP_NAME_T

# INCLUDE
TB_INCLUDE                      += $(wildcard ${TB_INCLUDE_DIR}/*.svh)
TB_INCLUDE                      += $(wildcard ${TB_INCLUDE_DIR}/*.vh)

SRC_SV							:= ${RTL_SRC_SV} ${TB_SRC}
SRC_V                           := ${RTL_SRC_V}
SRC_ALL							:= ${RTL_SRC_SV} ${RTL_SRC_V} ${TB_SRC} ${TB_INCLUDE}

# STIMULI GENERATION SCRIPT
GEN_STIM = generate_random_stimuli_${sim_top}.py

# EXAMPLE CONFIG GENERATION SCRIPT
GEN_EXAMPLE_CONFIG = generate_example_yaml_config.py

# DUMMY TARGET DIRECTORY
DUMMY_DIR						:= .Make_Dummies


###########################################################
# SIMULATION
###########################################################

##############################
# RUN SIMULATION
##############################

# * generate 'sim/vsim.do' with python script obtaining the necessary libraries 
# for Xilinx IPs
# * run questasim with the generated script and load wave file

.PHONY: vsim
vsim: ${DUMMY_DIR}/makeDummy_vsim_compile
ifndef sim_top
	@echo "You need to specify a top module via sim_top=...!!!"
else
	@./create_vsim_script.py tb__TT_APP_ABBREV_TT__${sim_top} ${XIL_IPS_DIR}
ifndef gui
	vsim -c -do "do vsim.do; run -all; exit"
else
	vsim -do "do vsim.do; do wave_tb__TT_APP_ABBREV_TT__${sim_top}.do; run -all"
endif
endif

##############################
# COMPILATION
##############################

# GLOBAL COMPILATION
# call single compilation targets
# TODO: parameterize testbench name for vsim generation
.PHONY: vsim_compile
vsim_compile:								${DUMMY_DIR}/makeDummy_vsim_compile	

ifeq (${generate_stimuli}, 1)
${DUMMY_DIR}/makeDummy_vsim_compile:		stim									\
											${DUMMY_DIR}/makeDummy_vsim_xil_compile	\
											${DUMMY_DIR}/makeDummy_vsim_rtl_compile 
else
${DUMMY_DIR}/makeDummy_vsim_compile:		${DUMMY_DIR}/makeDummy_vsim_xil_compile	\
											${DUMMY_DIR}/makeDummy_vsim_rtl_compile
endif
# 	vlib work
# 	vlog +incdir+$(abspath ${TB_DIR}/stim) ${RTL_SRC_SV} ${TB_SRC}
	@touch $@

# COMPILE PROJECT RTL FILES
ifeq (${generate_stimuli}, 1)
${DUMMY_DIR}/makeDummy_vsim_rtl_compile:	${SRC_ALL} stim 
else
${DUMMY_DIR}/makeDummy_vsim_rtl_compile:	${SRC_ALL}
endif
	vlib work
	vlog +incdir+$(abspath ${TB_DIR}/include) -sv ${SRC_SV}
	vlog +incdir+$(abspath ${TB_DIR}/include) ${SRC_V}
	@touch $@

# COMPILE XILINX IPS
# This target assumes that the IP simulation products have been generated by 
# the top-level makefile
${DUMMY_DIR}/makeDummy_vsim_xil_compile:	../${DUMMY_DIR}/makeDummy_xil_ip_sim_scripts
	$(addsuffix ;,${XIL_IP_COMPILE_FILES})
	@touch $@

##############################
# STIMULI GENERATION
##############################

# GENERATE STIMULI
.PHONY: stim
stim:                                       ${DUMMY_DIR}/makeDummy_stim

${DUMMY_DIR}/makeDummy_stim:                ${sim_top}_sim_config.yml
	python3 ${GEN_STIM}

##############################
# TEST PARAMETERIZATION
##############################

.PHONY: example_config
example_config:
	python3 ${GEN_EXAMPLE_CONFIG} ${sim_top}

###########################################################
# SETUP
###########################################################

.PHONY:	workspace
workspace:
	@mkdir -p ${DUMMY_DIR}
	@mkdir -p questa_lib


###########################################################
# DEBUG
###########################################################

.PHONY: debug
debug:
	@echo ${CONFIG_ALL}
